<section class="m-4">
  <h2 class="text-center"><%= @poll.title %></h2>
  <div class="poll-item">
    <h3 class="text-center">Poll Stats</h3>
    <table>
      <th>Item</th>
      <th>Vote Distributions</th>
      <th>Total Votes</th>
      <th>Response Rate</th>
      <th>Optional?</th>
      <th>Show Results to Voters</th>
      <th>Chart</th>

      <%= for %{item_id: item_id} = summary <- summarize_poll(@poll, map_size(@vote_table_values)) do %>
        <% item = Map.get(@item_map, item_id) %>
        <tr>
          <td><%= item.description %></td>
          <td><%= summary.vote_distributions %></td>
          <td><%= length(item.votes) %></td>
          <td><%= summary.response_rate %>%</td>
          <.form let={item_form} for={SacaStats.Poll.Item.update_changeset(item, %{})} phx-change="update-item">
            <%= hidden_input item_form, :id, value: item.id %>
            <td>
              <%= label do %>
                <%= checkbox item_form, :optional %>
                <%= error_tag item_form, :optional %>
              <% end %>
            </td>
            <td>
              <%= label do %>
                <%= checkbox item_form, :visible_results %>
                <%= error_tag item_form, :visible_results %>
              <% end %>
            </td>
          </.form>
          <td><%= summary.pie_chart %></td>
        </tr>
      <% end %>
    </table>
  </div>

  <div class="poll-item">
    <h3 class="text-center">Voters</h3>
    <table>
      <th>Voter</th>
      <%= for item <- @poll.items do %>
        <th><%= item.description %></th>
      <% end %>

      <%= for voter_id <- Map.keys(@vote_table_values) do %>
        <% vote_map = Map.get(@vote_table_values, voter_id) %>
        <tr>
          <td><%= get_discord_username(voter_id) %></td>
          <%= for item <- @poll.items do %>
            <% vote = Map.get(vote_map, item.id) %>
            <%= if is_nil(vote) do %>
              <td>N/A</td>
            <% else %>
              <td><%= vote.content %></td>
            <% end %>
          <% end %>
        </tr>
      <% end %>
    </table>
  </div>
</section>
